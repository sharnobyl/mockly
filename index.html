<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mockly</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<style id="google-fonts-inline"></style>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #1e1e1e; --surface: #2d2d2d; --border: #3d3d3d;
  --accent: #2d49b9; --accent-hover: #243a99; --text: #e0e0e0; --muted: #8c8c8c;
}
body {
  background: var(--bg); color: var(--text);
  font-family: 'DM Sans', sans-serif;
  display: grid;
  grid-template-columns: 400px 1fr;
  grid-template-rows: 52px 1fr;
  height: 100vh; overflow: hidden;
}
header {
  grid-column: 1/-1; background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 22px; gap: 10px;
}
header h1 { font-family:'Syne',sans-serif; font-weight:800; font-size:16px; }
header h1 span { color: var(--accent); }
.badge {
  background: var(--accent);
  color:#fff; font-size:9px; font-weight:700;
  padding:2px 7px; border-radius:99px; letter-spacing:1px; text-transform:uppercase;
  text-decoration: none;
}
.reset-btn {
  margin-left: auto;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--muted);
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.15s;
}
.reset-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.controls {
  background:var(--surface); border-right:1px solid var(--border);
  overflow-y:auto; padding:16px 16px 28px;
  display:flex; flex-direction:column; gap:3px;
}
.sec { font-family:'Syne',sans-serif; font-size:9px; font-weight:700;
  letter-spacing:1.5px; text-transform:uppercase; color:var(--muted);
  margin:14px 0 5px; }
.sec:first-child { margin-top:0; }

/* Control row with label + steppers */
.ctrl-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}
.ctrl-label {
  font-size: 11px;
  color: var(--muted);
}
.ctrl-steppers {
  display: flex;
  align-items: center;
  gap: 3px;
}
.stepper-btn {
  width: 22px; height: 22px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--muted);
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .12s;
}
.stepper-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.stepper-btn.reset {
  font-size: 10px;
}
.stepper-val {
  min-width: 36px;
  text-align: center;
  font-size: 11px;
  color: var(--text);
}

label { font-size:11px; color:var(--muted); display:block; margin-bottom:3px; }
input[type=text], textarea, select {
  width:100%; background:var(--bg); border:1px solid var(--border);
  border-radius:7px; color:var(--text); font-family:'DM Sans',sans-serif;
  font-size:12.5px; padding:6px 9px; outline:none;
  transition:border-color .15s; margin-bottom:8px;
}
input[type=text]:focus, textarea:focus, select:focus { border-color:var(--accent); }
textarea { resize:vertical; min-height:68px; line-height:1.5; }
select option { background:#2d2d2d; }
.presets { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:8px; }
.preset-btn {
  background:var(--bg); border:1px solid var(--border);
  border-radius:6px; color:var(--muted); font-size:10.5px;
  padding:4px 9px; cursor:pointer; transition:all .12s; font-family:'DM Sans',sans-serif;
}
.preset-btn:hover, .preset-btn.active { border-color:var(--accent); color:var(--accent); }
.slider-group { margin-bottom:8px; }
.slider-group label { display:flex; justify-content:space-between; align-items:center; }
.slider-group label span { color:var(--text); }
input[type=range] { width:100%; accent-color:var(--accent); margin-top:4px; display:block; }

/* Custom Color Picker */
.color-row { display:flex; align-items:center; gap:9px; margin-bottom:8px; position:relative; }
.color-trigger {
  width:32px; height:32px; border:1px solid var(--border);
  border-radius:6px; cursor:pointer; flex-shrink:0;
  position:relative; overflow:hidden;
}
.color-trigger-bg {
  position:absolute; inset:0;
  background:repeating-conic-gradient(#3d3d3d 0% 25%,#4a4a4a 0% 50%) 0 0/8px 8px;
}
.color-trigger-color { position:absolute; inset:0; }
.color-trigger:hover { border-color:var(--accent); }

.color-picker-popup {
  position:absolute; left:0; top:100%; margin-top:4px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:8px; padding:12px; z-index:1000;
  width:240px; box-shadow:0 8px 24px rgba(0,0,0,.4);
  display:none;
}
.color-picker-popup.open { display:block; }

.color-spectrum {
  width:100%; height:120px; border-radius:4px; position:relative;
  cursor:crosshair; margin-bottom:8px;
  background:linear-gradient(to right,#fff,currentColor);
}
.color-spectrum::after {
  content:''; position:absolute; inset:0;
  background:linear-gradient(to top,#000,transparent);
  border-radius:4px;
}
.color-spectrum-pointer {
  position:absolute; width:14px; height:14px;
  border:2px solid #fff; border-radius:50%;
  transform:translate(-50%,-50%);
  box-shadow:0 0 0 1px rgba(0,0,0,.3),0 2px 4px rgba(0,0,0,.3);
  pointer-events:none; z-index:1;
}

.color-hue-slider {
  width:100%; height:12px; border-radius:6px;
  background:linear-gradient(to right,
    hsl(0,100%,50%),hsl(60,100%,50%),hsl(120,100%,50%),
    hsl(180,100%,50%),hsl(240,100%,50%),hsl(300,100%,50%),hsl(360,100%,50%));
  position:relative; cursor:crosshair; margin-bottom:12px;
}
.color-hue-pointer {
  position:absolute; top:-2px; width:6px; height:16px;
  background:#fff; border-radius:2px;
  box-shadow:0 1px 3px rgba(0,0,0,.3);
  transform:translateX(-50%);
}

.color-alpha-slider {
  width:100%; height:12px; border-radius:6px;
  background:repeating-conic-gradient(#3d3d3d 0% 25%,#4a4a4a 0% 50%) 0 0/8px 8px;
  position:relative; cursor:crosshair; margin-bottom:12px;
}
.color-alpha-slider::after {
  content:''; position:absolute; inset:0;
  background:linear-gradient(to right, transparent, var(--alpha-color, #fff));
  border-radius:6px;
}
.color-alpha-pointer {
  position:absolute; top:-2px; width:6px; height:16px;
  background:#fff; border-radius:2px;
  box-shadow:0 1px 3px rgba(0,0,0,.3);
  transform:translateX(-50%);
}

.color-inputs {
  display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:6px;
  margin-bottom:10px;
}
.color-input-group { display:flex; flex-direction:column; gap:2px; }
.color-input-group label {
  font-size:9px; color:var(--muted); text-transform:uppercase;
  letter-spacing:0.5px; margin:0;
}
.color-input-group input {
  margin:0; padding:5px 6px; font-size:11px; text-align:center;
  font-family:'Courier New',monospace;
}
.color-hex-input {
  display:flex; align-items:center; gap:6px; margin-bottom:12px;
}
.color-hex-input label {
  font-size:10px; color:var(--muted); margin:0; font-weight:600;
}
.color-hex-input input {
  flex:1; margin:0; padding:5px 8px; font-size:12px;
  font-family:'Courier New',monospace;
}

.saved-colors { border-top:1px solid var(--border); padding-top:10px; }
.saved-colors-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:8px;
}
.saved-colors-header span {
  font-size:10px; color:var(--muted); text-transform:uppercase;
  letter-spacing:0.5px;
}
.save-color-btn {
  width:20px; height:20px; border:1px solid var(--border);
  border-radius:4px; background:var(--bg); color:var(--muted);
  font-size:14px; cursor:pointer; display:flex;
  align-items:center; justify-content:center;
  transition:all .12s;
}
.save-color-btn:hover { border-color:var(--accent); color:var(--accent); }
.saved-colors-list {
  display:flex; flex-wrap:wrap; gap:4px;
}
.saved-color-swatch {
  width:22px; height:22px; border-radius:4px; cursor:pointer;
  border:1px solid var(--border);
  position:relative;
}
.saved-color-swatch:hover { border-color:var(--accent); }
.saved-color-swatch .delete-btn {
  position:absolute; top:-4px; right:-4px;
  width:12px; height:12px; border-radius:50%;
  background:#ff4757; color:#fff; font-size:8px;
  display:none; align-items:center; justify-content:center;
  cursor:pointer;
}
.saved-color-swatch:hover .delete-btn { display:flex; }

.quick-colors {
  display:flex; align-items:center; gap:3px; margin-left:4px;
}
.quick-color-swatch {
  width:16px; height:16px; border-radius:3px; cursor:pointer;
  border:1px solid var(--border); flex-shrink:0;
  transition:border-color .12s;
}
.quick-color-swatch:hover { border-color:var(--accent); }

input[type=color] {
  width:32px; height:32px; border:1px solid var(--border);
  border-radius:6px; background:none; cursor:pointer; padding:2px; flex-shrink:0;
}
input[type=color]::-webkit-color-swatch-wrapper{padding:0;border-radius:4px}
input[type=color]::-webkit-color-swatch{border:none;border-radius:3px}
.upload-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.upload-btn {
  flex: 1;
  background:var(--bg); border:1px dashed var(--border);
  border-radius:7px; color:var(--muted); font-family:'DM Sans',sans-serif;
  font-size:11.5px; padding:8px; cursor:pointer; text-align:center;
  transition:all .15s;
}
.upload-btn:hover { border-color:var(--accent); color:var(--accent); }
.upload-btn.has-file { border-color:#4ade80; color:#4ade80; border-style:solid; }
.img-options { display:flex; gap:5px; margin-bottom:8px; }
.img-opt {
  flex:1; background:var(--bg); border:1px solid var(--border);
  border-radius:7px; color:var(--muted); font-size:10px;
  padding:6px 4px; cursor:pointer; text-align:center;
  transition:all .12s; font-family:'DM Sans',sans-serif; line-height:1.3;
}
.img-opt:hover, .img-opt.active { border-color:var(--accent); color:var(--accent); }
.aspect-options { display:flex; gap:5px; margin-bottom:8px; }
.aspect-opt {
  flex:1; background:var(--bg); border:1px solid var(--border);
  border-radius:7px; color:var(--muted); font-size:10px;
  padding:5px 4px; cursor:pointer; text-align:center;
  transition:all .12s; font-family:'DM Sans',sans-serif;
}
.aspect-opt:hover, .aspect-opt.active { border-color:var(--accent); color:var(--accent); }
.img-fit-opts { display:flex; gap:5px; margin-bottom:8px; }
.fit-opt {
  flex:1; padding:6px 8px; font-size:11px; border:1px solid var(--border);
  background:var(--bg); color:var(--muted); border-radius:5px; cursor:pointer;
}
.fit-opt.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.export-group { display:flex; flex-direction:column; gap:5px; margin-top:10px; }
.export-btn {
  width:100%; border:none; border-radius:7px;
  font-family:'Syne',sans-serif; font-weight:700; font-size:12px;
  letter-spacing:.3px; padding:9px; cursor:pointer; transition:opacity .15s, transform .1s;
}
.export-btn:hover { opacity:.88; transform:translateY(-1px); }
.export-btn:active { transform:translateY(0); }
.export-btn.primary { background:var(--accent); color:#fff; }
.export-btn.primary:hover { background:var(--accent-hover); }
.export-btn.sec-btn { background:var(--bg); border:1px solid var(--border); color:var(--text); }
.export-btn.sec-btn:hover { border-color:var(--accent); color:var(--accent); }
.toast {
  position:fixed; bottom:22px; left:50%;
  transform:translateX(-50%) translateY(14px);
  background:#3d3d3d; border:1px solid var(--border); color:var(--text);
  font-size:12.5px; padding:8px 18px; border-radius:99px;
  opacity:0; transition:all .2s; pointer-events:none; z-index:999;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* PREVIEW */
.preview-area {
  display:flex; align-items:center; justify-content:center;
  padding:32px; overflow:auto;
  background:repeating-conic-gradient(#2a2a2a 0% 25%,#242424 0% 50%) 0 0/16px 16px;
}

/* Mobile: Preview at top */
@media (max-width: 768px) {
  body {
    grid-template-columns: 1fr;
    grid-template-rows: 52px auto auto;
    height: auto;
    min-height: 100vh;
    overflow-x: hidden;
    overflow-y: auto;
  }
  .controls {
    order: 2;
    border-right: none;
    border-top: 1px solid var(--border);
    overflow-y: visible;
    max-height: none;
  }
  .preview-area {
    order: 1;
    padding: 16px;
    overflow: hidden;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 12px;
  }
  .zoom-controls {
    transform-origin: center;
  }
  .zoom-btn {
    width: 36px;
    height: 36px;
  }
}

/* Markdown styles in card */
.card-text strong { font-weight: 700; }
.card-text em { font-style: italic; }
.card-text code {
  background: rgba(0,0,0,0.2);
  padding: 1px 5px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}
.card-text a {
  color: inherit;
  text-decoration: underline;
  text-decoration-color: rgba(255,255,255,0.5);
}

/* THE CARD */
#card {
  border-radius:16px; overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
  position:relative; flex-shrink:0;
  display:flex; flex-direction:column;
}
.card-inner { padding:22px 22px 18px; flex-shrink:0; }
.card-header { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
#avatar-display {
  width:40px; height:40px; border-radius:50%;
  object-fit:cover; flex-shrink:0; background:#555;
}
.card-identity { display:flex; flex-direction:column; }
.card-name-row { display:flex; align-items:center; gap:5px; }
#display-name { font-weight:700; font-size:14.5px; line-height:1.2; }
.vbadge { width:16px; height:16px; flex-shrink:0; }
#display-handle { font-size:13px; margin-top:1px; }
.card-body { flex-shrink:0; }
#display-title { font-weight:800; font-size:18px; margin-bottom:10px; line-height:1.3; }
.card-text p { font-size:14.5px; line-height:1.55; margin-bottom:8px; }
.card-text p:last-child { margin-bottom:0; }

/* image wrappers */
.img-wrap {
  flex-shrink:0; overflow:hidden; line-height:0;
  transition: margin .15s, border-radius .15s;
}
.img-wrap img { width:100%; height:100%; display:block; transition: transform 0.1s; }
.img-wrap img.draggable { cursor: grab; }
.img-wrap img.dragging { cursor: grabbing; transition: none; }
.img-wrap img.contain-mode { cursor: default; object-fit: contain; }

/* Zoom controls */
.preview-area {
  position: relative;
  flex-direction: column;
  gap: 16px;
}
.preview-area > * {
  flex-shrink: 0;
}
.zoom-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.zoom-btn {
  width: 28px;
  height: 28px;
  border: 1px solid var(--border);
  border-radius: 5px;
  background: var(--bg);
  color: var(--text);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}
.zoom-btn:hover { border-color: var(--accent); color: var(--accent); }
.zoom-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.zoom-value {
  font-size: 12px;
  color: var(--text);
  min-width: 40px;
  text-align: center;
  font-family: 'DM Sans', sans-serif;
}
.img-placeholder {
  width:100%; height:100%; display:flex; align-items:center; justify-content:center;
  color:rgba(255,255,255,.2); font-size:12px; background:rgba(0,0,0,.12);
}
</style>
</head>
<body>

<header>
  <h1>Mock<span>ly</span></h1>
  <a href="https://hotoffthepatentpress.com" target="_blank" class="badge">by Hot Off The Patent Press</a>
  <button class="reset-btn" onclick="resetAll()">Reset</button>
</header>

<!-- CONTROLS -->
<div class="controls">

  <div class="sec">Platform Presets</div>
  <div class="presets">
    <button class="preset-btn active" data-preset="twitter">Twitter/X</button>
    <button class="preset-btn" data-preset="instagram">Instagram</button>
    <button class="preset-btn" data-preset="linkedin">LinkedIn</button>
    <button class="preset-btn" data-preset="story">Story</button>
    <button class="preset-btn" data-preset="og">OG Image</button>
  </div>

  <div class="sec">Canvas Size</div>
  <div class="ctrl-row">
    <span class="ctrl-label">Width</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('width', -10)">−</button>
      <span class="stepper-val" id="w-val">516px</span>
      <button class="stepper-btn" onclick="adjustValue('width', 10)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('width')">↺</button>
    </div>
  </div>
  <input type="range" id="w-range" min="300" max="900" value="516" oninput="onSizeChange()">
  <div class="ctrl-row">
    <span class="ctrl-label">Height</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('height', -10)">−</button>
      <span class="stepper-val" id="h-val">auto</span>
      <button class="stepper-btn" onclick="adjustValue('height', 10)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('height')">↺</button>
    </div>
  </div>
  <input type="range" id="h-range" min="0" max="900" value="0" oninput="onSizeChange()">
  <div style="font-size:10px;opacity:.5;margin-bottom:8px">0 = auto-height</div>

  <div class="sec">Profile</div>
  <div class="upload-row">
    <button class="upload-btn" id="avatar-btn" onclick="document.getElementById('avatar-upload').click()">↑ Upload avatar</button>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('avatarSize', -2)">−</button>
      <span class="stepper-val" id="avatar-size-val">40</span>
      <button class="stepper-btn" onclick="adjustValue('avatarSize', 2)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('avatarSize')">↺</button>
    </div>
  </div>
  <input type="file" id="avatar-upload" accept="image/*" style="display:none" onchange="handleAvatar(event)">

  <div class="ctrl-row">
    <span class="ctrl-label">Display Name</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('nameSize', -0.5)">−</button>
      <span class="stepper-val" id="name-size-val">14.5</span>
      <button class="stepper-btn" onclick="adjustValue('nameSize', 0.5)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('nameSize')">↺</button>
    </div>
  </div>
  <input type="text" id="name-input" value="Mockly" oninput="liveUpdate()">

  <div class="ctrl-row">
    <span class="ctrl-label">Handle</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('handleSize', -0.5)">−</button>
      <span class="stepper-val" id="handle-size-val">13</span>
      <button class="stepper-btn" onclick="adjustValue('handleSize', 0.5)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('handleSize')">↺</button>
    </div>
  </div>
  <input type="text" id="handle-input" value="@mockly.app" oninput="liveUpdate()">

  <label>Verified Badge</label>
  <select id="verified-select" onchange="liveUpdate()">
    <option value="blue">Blue ✓</option>
    <option value="gold">Gold ✓</option>
    <option value="none">None</option>
  </select>

  <div class="sec">Content</div>
  <div class="ctrl-row">
    <span class="ctrl-label">Headline</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('titleSize', -1)">−</button>
      <span class="stepper-val" id="title-size-val">18</span>
      <button class="stepper-btn" onclick="adjustValue('titleSize', 1)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('titleSize')">↺</button>
    </div>
  </div>
  <input type="text" id="title-input" value="Create beautiful social cards" oninput="liveUpdate()">

  <div class="ctrl-row">
    <span class="ctrl-label">Body (supports **bold**, *italic*, `code`, [link](url))</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('bodySize', -0.5)">−</button>
      <span class="stepper-val" id="body-size-val">14.5</span>
      <button class="stepper-btn" onclick="adjustValue('bodySize', 0.5)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('bodySize')">↺</button>
    </div>
  </div>
  <textarea id="body-input" oninput="liveUpdate()">Design Twitter/X-style social cards in seconds.
Customize colors, fonts, images, and layout. Export as PNG or JPEG.
Perfect for sharing blog posts, product launches, or announcements.</textarea>

  <div class="sec">Card Image</div>
  <label style="margin-bottom:6px">
    <input type="checkbox" id="show-img-check" onchange="liveUpdate()" checked
      style="accent-color:var(--accent);margin-right:5px">
    Show image
  </label>
  <button class="upload-btn" id="card-img-btn" onclick="document.getElementById('card-img-upload').click()">↑ Upload image</button>
  <input type="file" id="card-img-upload" accept="image/*" style="display:none" onchange="handleCardImage(event)">

  <label>Image Position</label>
  <div class="img-options">
    <button class="img-opt active" data-pos="bottom">↓ Bottom</button>
    <button class="img-opt" data-pos="top">↑ Top</button>
  </div>

  <label>Aspect Ratio</label>
  <div class="aspect-options">
    <button class="aspect-opt active" data-ratio="16/9">16:9</button>
    <button class="aspect-opt" data-ratio="4/3">4:3</button>
    <button class="aspect-opt" data-ratio="1/1">1:1</button>
    <button class="aspect-opt" data-ratio="9/16">9:16</button>
  </div>

  <label>Image Fit</label>
  <div class="img-fit-opts">
    <button class="fit-opt active" data-fit="cover">Cover</button>
    <button class="fit-opt" data-fit="contain">Contain</button>
  </div>

  <label style="margin-top:2px">
    <input type="checkbox" id="rounded-img-check" onchange="liveUpdate()" checked
      style="accent-color:var(--accent);margin-right:5px">
    Rounded image corners
  </label>

  <div class="ctrl-row" style="margin-top:8px">
    <span class="ctrl-label">Image Inset</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('inset', -1)">−</button>
      <span class="stepper-val" id="inset-val">10</span>
      <button class="stepper-btn" onclick="adjustValue('inset', 1)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('inset')">↺</button>
    </div>
  </div>
  <input type="range" id="inset-range" min="0" max="24" value="10" oninput="liveUpdate()">

  <div class="sec">Style</div>
  <div class="color-row">
    <div class="color-trigger" id="bg-trigger" onclick="toggleColorPicker('bg')">
      <div class="color-trigger-bg"></div>
      <div class="color-trigger-color" id="bg-trigger-color"></div>
    </div>
    <label style="margin:0;flex:1">Background</label>
    <div class="quick-colors" id="bg-quick-colors"></div>
    <button class="stepper-btn reset" onclick="resetValue('bgColor')">↺</button>
    <div class="color-picker-popup" id="bg-picker">
      <div class="color-spectrum" id="bg-spectrum">
        <div class="color-spectrum-pointer" id="bg-spectrum-pointer"></div>
      </div>
      <div class="color-hue-slider" id="bg-hue">
        <div class="color-hue-pointer" id="bg-hue-pointer"></div>
      </div>
      <div class="color-alpha-slider" id="bg-alpha">
        <div class="color-alpha-pointer" id="bg-alpha-pointer"></div>
      </div>
      <div class="color-hex-input">
        <label>HEX</label>
        <input type="text" id="bg-hex" maxlength="7">
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>R</label>
          <input type="number" id="bg-r" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>G</label>
          <input type="number" id="bg-g" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>B</label>
          <input type="number" id="bg-b" min="0" max="255">
        </div>
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>H</label>
          <input type="number" id="bg-h" min="0" max="360">
        </div>
        <div class="color-input-group">
          <label>S</label>
          <input type="number" id="bg-s" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>L</label>
          <input type="number" id="bg-l" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>A</label>
          <input type="number" id="bg-a" min="0" max="100">
        </div>
      </div>
      <div class="saved-colors" style="display:flex;justify-content:center;padding-top:8px;">
        <button class="save-color-btn" onclick="saveColor('bg')" title="Save current color">+</button>
      </div>
    </div>
  </div>
  <div class="color-row">
    <div class="color-trigger" id="name-trigger" onclick="toggleColorPicker('name')">
      <div class="color-trigger-bg"></div>
      <div class="color-trigger-color" id="name-trigger-color"></div>
    </div>
    <label style="margin:0;flex:1">Name color</label>
    <div class="quick-colors" id="name-quick-colors"></div>
    <button class="stepper-btn reset" onclick="resetValue('nameColor')">↺</button>
    <div class="color-picker-popup" id="name-picker">
      <div class="color-spectrum" id="name-spectrum">
        <div class="color-spectrum-pointer" id="name-spectrum-pointer"></div>
      </div>
      <div class="color-hue-slider" id="name-hue">
        <div class="color-hue-pointer" id="name-hue-pointer"></div>
      </div>
      <div class="color-alpha-slider" id="name-alpha">
        <div class="color-alpha-pointer" id="name-alpha-pointer"></div>
      </div>
      <div class="color-hex-input">
        <label>HEX</label>
        <input type="text" id="name-hex" maxlength="7">
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>R</label>
          <input type="number" id="name-r" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>G</label>
          <input type="number" id="name-g" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>B</label>
          <input type="number" id="name-b" min="0" max="255">
        </div>
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>H</label>
          <input type="number" id="name-h" min="0" max="360">
        </div>
        <div class="color-input-group">
          <label>S</label>
          <input type="number" id="name-s" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>L</label>
          <input type="number" id="name-l" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>A</label>
          <input type="number" id="name-a" min="0" max="100">
        </div>
      </div>
      <div class="saved-colors" style="display:flex;justify-content:center;padding-top:8px;">
        <button class="save-color-btn" onclick="saveColor('name')" title="Save current color">+</button>
      </div>
    </div>
  </div>
  <div class="color-row">
    <div class="color-trigger" id="handle-trigger" onclick="toggleColorPicker('handle')">
      <div class="color-trigger-bg"></div>
      <div class="color-trigger-color" id="handle-trigger-color"></div>
    </div>
    <label style="margin:0;flex:1">Handle color</label>
    <div class="quick-colors" id="handle-quick-colors"></div>
    <button class="stepper-btn reset" onclick="resetValue('handleColor')">↺</button>
    <div class="color-picker-popup" id="handle-picker">
      <div class="color-spectrum" id="handle-spectrum">
        <div class="color-spectrum-pointer" id="handle-spectrum-pointer"></div>
      </div>
      <div class="color-hue-slider" id="handle-hue">
        <div class="color-hue-pointer" id="handle-hue-pointer"></div>
      </div>
      <div class="color-alpha-slider" id="handle-alpha">
        <div class="color-alpha-pointer" id="handle-alpha-pointer"></div>
      </div>
      <div class="color-hex-input">
        <label>HEX</label>
        <input type="text" id="handle-hex" maxlength="7">
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>R</label>
          <input type="number" id="handle-r" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>G</label>
          <input type="number" id="handle-g" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>B</label>
          <input type="number" id="handle-b" min="0" max="255">
        </div>
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>H</label>
          <input type="number" id="handle-h" min="0" max="360">
        </div>
        <div class="color-input-group">
          <label>S</label>
          <input type="number" id="handle-s" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>L</label>
          <input type="number" id="handle-l" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>A</label>
          <input type="number" id="handle-a" min="0" max="100">
        </div>
      </div>
      <div class="saved-colors" style="display:flex;justify-content:center;padding-top:8px;">
        <button class="save-color-btn" onclick="saveColor('handle')" title="Save current color">+</button>
      </div>
    </div>
  </div>
  <div class="color-row">
    <div class="color-trigger" id="headline-trigger" onclick="toggleColorPicker('headline')">
      <div class="color-trigger-bg"></div>
      <div class="color-trigger-color" id="headline-trigger-color"></div>
    </div>
    <label style="margin:0;flex:1">Headline color</label>
    <div class="quick-colors" id="headline-quick-colors"></div>
    <button class="stepper-btn reset" onclick="resetValue('headlineColor')">↺</button>
    <div class="color-picker-popup" id="headline-picker">
      <div class="color-spectrum" id="headline-spectrum">
        <div class="color-spectrum-pointer" id="headline-spectrum-pointer"></div>
      </div>
      <div class="color-hue-slider" id="headline-hue">
        <div class="color-hue-pointer" id="headline-hue-pointer"></div>
      </div>
      <div class="color-alpha-slider" id="headline-alpha">
        <div class="color-alpha-pointer" id="headline-alpha-pointer"></div>
      </div>
      <div class="color-hex-input">
        <label>HEX</label>
        <input type="text" id="headline-hex" maxlength="7">
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>R</label>
          <input type="number" id="headline-r" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>G</label>
          <input type="number" id="headline-g" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>B</label>
          <input type="number" id="headline-b" min="0" max="255">
        </div>
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>H</label>
          <input type="number" id="headline-h" min="0" max="360">
        </div>
        <div class="color-input-group">
          <label>S</label>
          <input type="number" id="headline-s" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>L</label>
          <input type="number" id="headline-l" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>A</label>
          <input type="number" id="headline-a" min="0" max="100">
        </div>
      </div>
      <div class="saved-colors" style="display:flex;justify-content:center;padding-top:8px;">
        <button class="save-color-btn" onclick="saveColor('headline')" title="Save current color">+</button>
      </div>
    </div>
  </div>
  <div class="color-row">
    <div class="color-trigger" id="body-trigger" onclick="toggleColorPicker('body')">
      <div class="color-trigger-bg"></div>
      <div class="color-trigger-color" id="body-trigger-color"></div>
    </div>
    <label style="margin:0;flex:1">Body color</label>
    <div class="quick-colors" id="body-quick-colors"></div>
    <button class="stepper-btn reset" onclick="resetValue('bodyColor')">↺</button>
    <div class="color-picker-popup" id="body-picker">
      <div class="color-spectrum" id="body-spectrum">
        <div class="color-spectrum-pointer" id="body-spectrum-pointer"></div>
      </div>
      <div class="color-hue-slider" id="body-hue">
        <div class="color-hue-pointer" id="body-hue-pointer"></div>
      </div>
      <div class="color-alpha-slider" id="body-alpha">
        <div class="color-alpha-pointer" id="body-alpha-pointer"></div>
      </div>
      <div class="color-hex-input">
        <label>HEX</label>
        <input type="text" id="body-hex" maxlength="7">
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>R</label>
          <input type="number" id="body-r" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>G</label>
          <input type="number" id="body-g" min="0" max="255">
        </div>
        <div class="color-input-group">
          <label>B</label>
          <input type="number" id="body-b" min="0" max="255">
        </div>
      </div>
      <div class="color-inputs">
        <div class="color-input-group">
          <label>H</label>
          <input type="number" id="body-h" min="0" max="360">
        </div>
        <div class="color-input-group">
          <label>S</label>
          <input type="number" id="body-s" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>L</label>
          <input type="number" id="body-l" min="0" max="100">
        </div>
        <div class="color-input-group">
          <label>A</label>
          <input type="number" id="body-a" min="0" max="100">
        </div>
      </div>
      <div class="saved-colors" style="display:flex;justify-content:center;padding-top:8px;">
        <button class="save-color-btn" onclick="saveColor('body')" title="Save current color">+</button>
      </div>
    </div>
  </div>
  <label>Font</label>
  <select id="font-select" onchange="liveUpdate()">
    <option value="system">System UI</option>
    <option value="georgia">Georgia (Serif)</option>
    <option value="courier">Courier New (Mono)</option>
    <option value="syne">Syne (Geometric)</option>
    <option value="dmsans">DM Sans (Clean)</option>
  </select>

  <div class="ctrl-row">
    <span class="ctrl-label">Corner Radius</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('cornerRadius', -1)">−</button>
      <span class="stepper-val" id="radius-val">16</span>
      <button class="stepper-btn" onclick="adjustValue('cornerRadius', 1)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('cornerRadius')">↺</button>
    </div>
  </div>
  <input type="range" id="radius-range" min="0" max="40" value="16" oninput="liveUpdate()">

  <div class="export-group">
    <button class="export-btn primary" onclick="exportCard('png')">⬇ Download PNG</button>
    <button class="export-btn sec-btn" onclick="exportCard('jpeg')">⬇ Download JPEG</button>
    <button class="export-btn sec-btn" onclick="copyCard()">⎘ Copy to Clipboard</button>
  </div>
</div>

<!-- PREVIEW -->
<div class="preview-area">
  <div id="card">
    <!-- top image slot -->
    <div id="img-slot-top" class="img-wrap" style="display:none">
      <img id="img-top" alt="">
      <div class="img-placeholder" id="ph-top"></div>
    </div>

    <div class="card-inner">
      <div class="card-header">
        <img id="avatar-display" src="" alt="avatar">
        <div class="card-identity">
          <div class="card-name-row">
            <span id="display-name">Mockly</span>
            <svg id="verified-icon" class="vbadge" viewBox="0 0 22 22" fill="none">
              <circle cx="11" cy="11" r="11" fill="#2d49b9"/>
              <path d="M7 11.5L10 14.5L15 8.5" stroke="white" stroke-width="2.2"
                stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <span id="display-handle">@mockly.app</span>
        </div>
      </div>

      <div class="card-body">
        <div id="display-title">Create beautiful social cards</div>
        <div id="display-body" class="card-text"></div>
      </div>

    </div>

    <!-- bottom image slot -->
    <div id="img-slot-bottom" class="img-wrap">
      <img id="img-bottom" alt="" style="display:none">
      <div class="img-placeholder" id="ph-bottom">No image uploaded</div>
    </div>
  </div>

  <!-- Zoom controls (outside card so not included in exports) -->
  <div class="zoom-controls" id="zoom-controls">
    <button class="zoom-btn" id="zoom-out" title="Zoom out">−</button>
    <span class="zoom-value" id="zoom-value">100%</span>
    <button class="zoom-btn" id="zoom-in" title="Zoom in">+</button>
    <button class="zoom-btn" id="zoom-reset" title="Reset zoom">↺</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
<script>
// DEFAULTS
const DEFAULTS = {
  width: 516,
  height: 0,
  nameSize: 14.5,
  handleSize: 13,
  titleSize: 18,
  bodySize: 14.5,
  avatarSize: 40,
  cornerRadius: 16,
  inset: 10,
  bgColor: '#000000',
  nameColor: '#ffffff',
  handleColor: '#999999',
  headlineColor: '#ffffff',
  bodyColor: '#e0e0e0'
};

// Current state (sizes)
const sizes = {
  nameSize: DEFAULTS.nameSize,
  handleSize: DEFAULTS.handleSize,
  titleSize: DEFAULTS.titleSize,
  bodySize: DEFAULTS.bodySize,
  avatarSize: DEFAULTS.avatarSize,
  cornerRadius: DEFAULTS.cornerRadius,
  inset: DEFAULTS.inset,
  width: DEFAULTS.width,
  height: DEFAULTS.height
};

let avatarDataURL  = null;
let cardImgDataURL = null;
let imgPosition    = 'bottom';
let imgRatio       = '16/9';
let imgFit         = 'cover';
let imgOffsetX     = 0; // pixels for translate
let imgOffsetY     = 0; // pixels for translate
let imgZoom        = 1;  // scale factor (1 = 100%)

const PLATFORM_PRESETS = {
  twitter:   { w: 516, h: 0 },
  instagram: { w: 600, h: 600 },
  linkedin:  { w: 700, h: 0 },
  story:     { w: 400, h: 711 },
  og:        { w: 800, h: 418 },
};

const FONT_CSS = {
  system:  "-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif",
  georgia: "Georgia,serif",
  courier: "'Courier New',monospace",
  syne:    "Syne,sans-serif",
  dmsans:  "'DM Sans',sans-serif",
};

// Sizing limits
const LIMITS = {
  nameSize: { min: 10, max: 24, step: 0.5 },
  handleSize: { min: 10, max: 20, step: 0.5 },
  titleSize: { min: 12, max: 32, step: 1 },
  bodySize: { min: 10, max: 24, step: 0.5 },
  avatarSize: { min: 24, max: 64, step: 2 },
  cornerRadius: { min: 0, max: 40, step: 1 },
  inset: { min: 0, max: 24, step: 1 },
  width: { min: 300, max: 900, step: 10 },
  height: { min: 0, max: 900, step: 10 }
};

function gv(id){ return document.getElementById(id).value; }
function sv(id, val){ document.getElementById(id).value = val; }
function ratioNum(r){ const [a,b]=r.split('/').map(Number); return a/b; }

// ============ COLOR PICKER ============
const colorPickerState = {
  bg: { hex: '#000000', h: 0, s: 0, l: 0, a: 100 },
  name: { hex: '#ffffff', h: 0, s: 0, l: 100, a: 100 },
  handle: { hex: '#999999', h: 0, s: 0, l: 60, a: 100 },
  headline: { hex: '#ffffff', h: 0, s: 0, l: 100, a: 100 },
  body: { hex: '#e0e0e0', h: 0, s: 0, l: 88, a: 100 }
};

// Color conversion utilities
function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : { r: 0, g: 0, b: 0 };
}

function rgbToHex(r, g, b) {
  return '#' + [r, g, b].map(x => {
    const hex = Math.round(Math.max(0, Math.min(255, x))).toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  }).join('');
}

function hslToRgb(h, s, l) {
  h /= 360; s /= 100; l /= 100;
  let r, g, b;
  if (s === 0) {
    r = g = b = l;
  } else {
    const hue2rgb = (p, q, t) => {
      if (t < 0) t += 1;
      if (t > 1) t -= 1;
      if (t < 1/6) return p + (q - p) * 6 * t;
      if (t < 1/2) return q;
      if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
      return p;
    };
    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
    const p = 2 * l - q;
    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }
  return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
}

function rgbToHsl(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;
  if (max === min) {
    h = s = 0;
  } else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
      case g: h = ((b - r) / d + 2) / 6; break;
      case b: h = ((r - g) / d + 4) / 6; break;
    }
  }
  return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
}

function hsvToHsl(h, s, v) {
  s /= 100; v /= 100;
  const l = (2 - s) * v / 2;
  const sOut = l && l < 1 ? s * v / (l < 0.5 ? l * 2 : 2 - l * 2) : s;
  return { h: h, s: Math.round(sOut * 100), l: Math.round(l * 100) };
}

function hslToHsv(h, s, l) {
  s /= 100; l /= 100;
  const v = l + s * Math.min(l, 1 - l);
  const sOut = v ? 2 * (1 - l / v) : 0;
  return { h: h, s: Math.round(sOut * 100), v: Math.round(v * 100) };
}

function updateColorPickerUI(prefix) {
  const state = colorPickerState[prefix];
  const rgb = hslToRgb(state.h, state.s, state.l);
  const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
  state.hex = hex;

  // Update trigger swatch (show checkerboard behind if alpha < 100)
  const triggerColor = document.getElementById(`${prefix}-trigger-color`);
  if (state.a < 100) {
    triggerColor.style.background = `rgba(${rgb.r},${rgb.g},${rgb.b},${state.a / 100})`;
  } else {
    triggerColor.style.background = hex;
  }

  // Update spectrum background (hue)
  document.getElementById(`${prefix}-spectrum`).style.color = `hsl(${state.h}, 100%, 50%)`;

  // Update spectrum pointer position
  const hsv = hslToHsv(state.h, state.s, state.l);
  const spectrum = document.getElementById(`${prefix}-spectrum`);
  const pointer = document.getElementById(`${prefix}-spectrum-pointer`);
  pointer.style.left = `${hsv.s}%`;
  pointer.style.top = `${100 - hsv.v}%`;

  // Update hue pointer
  document.getElementById(`${prefix}-hue-pointer`).style.left = `${(state.h / 360) * 100}%`;

  // Update alpha slider
  const alphaSlider = document.getElementById(`${prefix}-alpha`);
  alphaSlider.style.setProperty('--alpha-color', `hsl(${state.h}, ${state.s}%, ${state.l}%)`);
  document.getElementById(`${prefix}-alpha-pointer`).style.left = `${state.a}%`;

  // Update inputs
  document.getElementById(`${prefix}-hex`).value = hex;
  document.getElementById(`${prefix}-r`).value = rgb.r;
  document.getElementById(`${prefix}-g`).value = rgb.g;
  document.getElementById(`${prefix}-b`).value = rgb.b;
  document.getElementById(`${prefix}-h`).value = state.h;
  document.getElementById(`${prefix}-s`).value = state.s;
  document.getElementById(`${prefix}-l`).value = state.l;
  document.getElementById(`${prefix}-a`).value = state.a;
}

function setColorFromHSL(prefix, h, s, l, a) {
  colorPickerState[prefix].h = h;
  colorPickerState[prefix].s = s;
  colorPickerState[prefix].l = l;
  if (a !== undefined) colorPickerState[prefix].a = a;
  updateColorPickerUI(prefix);
  liveUpdate();
}

function setColorFromHex(prefix, hex) {
  if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) return;
  const rgb = hexToRgb(hex);
  const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
  colorPickerState[prefix].h = hsl.h;
  colorPickerState[prefix].s = hsl.s;
  colorPickerState[prefix].l = hsl.l;
  updateColorPickerUI(prefix);
  liveUpdate();
}

function getPickerColor(prefix) {
  const state = colorPickerState[prefix];
  if (state.a < 100) {
    const rgb = hslToRgb(state.h, state.s, state.l);
    return `rgba(${rgb.r},${rgb.g},${rgb.b},${(state.a / 100).toFixed(2)})`;
  }
  return state.hex;
}

function toggleColorPicker(prefix) {
  const popup = document.getElementById(`${prefix}-picker`);
  const isOpen = popup.classList.contains('open');
  // Close all pickers
  document.querySelectorAll('.color-picker-popup').forEach(p => p.classList.remove('open'));
  if (!isOpen) {
    popup.classList.add('open');
  }
}

// Saved colors with localStorage
const PRESET_COLORS = ['#ffffff', '#eae4d3', '#999999', '#2d49b8', '#000000'];

function getSavedColors() {
  let saved = [];
  try {
    saved = JSON.parse(localStorage.getItem('mocklySavedColors')) || [];
  } catch { saved = []; }
  // Merge presets with saved, presets first, avoiding duplicates
  const merged = [...PRESET_COLORS];
  saved.forEach(c => {
    if (!merged.includes(c)) merged.push(c);
  });
  return merged;
}

function saveColorToStorage(hex) {
  const colors = getSavedColors();
  if (!colors.includes(hex)) {
    colors.unshift(hex);
    if (colors.length > 16) colors.pop();
    localStorage.setItem('mocklySavedColors', JSON.stringify(colors));
  }
  renderSavedColors();
}

function deleteSavedColor(hex) {
  const colors = getSavedColors().filter(c => c !== hex);
  localStorage.setItem('mocklySavedColors', JSON.stringify(colors));
  renderSavedColors();
}

function renderSavedColors() {
  const colors = getSavedColors();
  ['bg', 'name', 'handle', 'headline', 'body'].forEach(prefix => {
    const container = document.getElementById(`${prefix}-quick-colors`);
    if (container) {
      container.innerHTML = colors.slice(0, 6).map(c => `
        <div class="quick-color-swatch" style="background:${c}" onclick="applySavedColor('${prefix}', '${c}')" title="${c}"></div>
      `).join('');
    }
  });
}

function saveColor(prefix) {
  saveColorToStorage(colorPickerState[prefix].hex);
}

function applySavedColor(prefix, hex) {
  setColorFromHex(prefix, hex);
}

// Spectrum and hue interactions
function setupColorPickerInteractions(prefix) {
  const spectrum = document.getElementById(`${prefix}-spectrum`);
  const hue = document.getElementById(`${prefix}-hue`);
  const alpha = document.getElementById(`${prefix}-alpha`);

  let isDraggingSpectrum = false;
  let isDraggingHue = false;
  let isDraggingAlpha = false;

  function handleSpectrumMove(e) {
    const rect = spectrum.getBoundingClientRect();
    const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    const y = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
    const hsv = hslToHsv(colorPickerState[prefix].h, colorPickerState[prefix].s, colorPickerState[prefix].l);
    const hsl = hsvToHsl(colorPickerState[prefix].h, x * 100, (1 - y) * 100);
    setColorFromHSL(prefix, colorPickerState[prefix].h, hsl.s, hsl.l);
  }

  function handleHueMove(e) {
    const rect = hue.getBoundingClientRect();
    const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    const h = Math.round(x * 360);
    const state = colorPickerState[prefix];
    setColorFromHSL(prefix, h, state.s, state.l);
  }

  function handleAlphaMove(e) {
    const rect = alpha.getBoundingClientRect();
    const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    const a = Math.round(x * 100);
    const state = colorPickerState[prefix];
    setColorFromHSL(prefix, state.h, state.s, state.l, a);
  }

  spectrum.addEventListener('mousedown', e => { isDraggingSpectrum = true; handleSpectrumMove(e); });
  hue.addEventListener('mousedown', e => { isDraggingHue = true; handleHueMove(e); });
  alpha.addEventListener('mousedown', e => { isDraggingAlpha = true; handleAlphaMove(e); });

  document.addEventListener('mousemove', e => {
    if (isDraggingSpectrum) handleSpectrumMove(e);
    if (isDraggingHue) handleHueMove(e);
    if (isDraggingAlpha) handleAlphaMove(e);
  });
  document.addEventListener('mouseup', () => { isDraggingSpectrum = false; isDraggingHue = false; isDraggingAlpha = false; });

  // Input handlers
  document.getElementById(`${prefix}-hex`).addEventListener('input', e => {
    let val = e.target.value;
    if (!val.startsWith('#')) val = '#' + val;
    if (/^#[0-9A-Fa-f]{6}$/.test(val)) setColorFromHex(prefix, val);
  });

  ['r', 'g', 'b'].forEach(ch => {
    document.getElementById(`${prefix}-${ch}`).addEventListener('input', e => {
      const r = parseInt(document.getElementById(`${prefix}-r`).value) || 0;
      const g = parseInt(document.getElementById(`${prefix}-g`).value) || 0;
      const b = parseInt(document.getElementById(`${prefix}-b`).value) || 0;
      const hsl = rgbToHsl(r, g, b);
      setColorFromHSL(prefix, hsl.h, hsl.s, hsl.l);
    });
  });

  ['h', 's', 'l'].forEach(ch => {
    document.getElementById(`${prefix}-${ch}`).addEventListener('input', e => {
      const h = parseInt(document.getElementById(`${prefix}-h`).value) || 0;
      const s = parseInt(document.getElementById(`${prefix}-s`).value) || 0;
      const l = parseInt(document.getElementById(`${prefix}-l`).value) || 0;
      setColorFromHSL(prefix, h, s, l);
    });
  });

  // Alpha input handler
  document.getElementById(`${prefix}-a`).addEventListener('input', e => {
    const a = Math.max(0, Math.min(100, parseInt(e.target.value) || 0));
    const state = colorPickerState[prefix];
    setColorFromHSL(prefix, state.h, state.s, state.l, a);
  });
}

// Close pickers when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.color-row')) {
    document.querySelectorAll('.color-picker-popup').forEach(p => p.classList.remove('open'));
  }
});

function initColorPickers() {
  ['bg', 'name', 'handle', 'headline', 'body'].forEach(prefix => {
    setupColorPickerInteractions(prefix);
    updateColorPickerUI(prefix);
  });
  renderSavedColors();
}
// ============ END COLOR PICKER ============

// Stepper functions
function adjustValue(key, delta) {
  const limit = LIMITS[key];
  sizes[key] = Math.max(limit.min, Math.min(limit.max, sizes[key] + delta));
  updateStepperUI(key);
  syncSliderToState(key);
  // Update card width/height directly when adjusting
  if (key === 'width') {
    document.getElementById('card').style.width = sizes.width + 'px';
  }
  liveUpdate();
}

function resetValue(key) {
  if (key === 'bgColor') {
    setColorFromHex('bg', DEFAULTS.bgColor);
    return;
  }
  if (key === 'nameColor') {
    setColorFromHex('name', DEFAULTS.nameColor);
    return;
  }
  if (key === 'handleColor') {
    setColorFromHex('handle', DEFAULTS.handleColor);
    return;
  }
  if (key === 'headlineColor') {
    setColorFromHex('headline', DEFAULTS.headlineColor);
    return;
  }
  if (key === 'bodyColor') {
    setColorFromHex('body', DEFAULTS.bodyColor);
    return;
  }
  sizes[key] = DEFAULTS[key];
  updateStepperUI(key);
  syncSliderToState(key);
  liveUpdate();
}

function updateStepperUI(key) {
  const valEl = document.getElementById(keyToValId(key));
  if (valEl) {
    let display = sizes[key];
    if (key === 'width') {
      valEl.textContent = display + 'px';
    } else if (key === 'height') {
      valEl.textContent = display === 0 ? 'auto' : display + 'px';
    } else {
      valEl.textContent = display;
    }
  }
}

function keyToValId(key) {
  const map = {
    nameSize: 'name-size-val',
    handleSize: 'handle-size-val',
    titleSize: 'title-size-val',
    bodySize: 'body-size-val',
    avatarSize: 'avatar-size-val',
    cornerRadius: 'radius-val',
    inset: 'inset-val',
    width: 'w-val',
    height: 'h-val'
  };
  return map[key];
}

function keyToRangeId(key) {
  const map = {
    cornerRadius: 'radius-range',
    inset: 'inset-range',
    width: 'w-range',
    height: 'h-range'
  };
  return map[key];
}

function syncSliderToState(key) {
  const rangeId = keyToRangeId(key);
  if (rangeId) {
    const range = document.getElementById(rangeId);
    if (range) range.value = sizes[key];
  }
}

// Markdown parser (basic)
function parseMarkdown(text) {
  return text
    // Escape HTML
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    // Links: [text](url)
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
    // Bold: **text** or __text__
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/__([^_]+)__/g, '<strong>$1</strong>')
    // Italic: *text* or _text_
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/_([^_]+)_/g, '<em>$1</em>')
    // Code: `text`
    .replace(/`([^`]+)`/g, '<code>$1</code>');
}

function makeInitialsAvatar(name, fg, bg, size){
  const c=document.createElement('canvas');
  const canvasSize = size * 2;
  c.width=c.height=canvasSize;
  const x=c.getContext('2d');
  x.fillStyle=bg; x.beginPath(); x.arc(canvasSize/2,canvasSize/2,canvasSize/2,0,Math.PI*2); x.fill();
  const ini=(name||'?').trim().split(/\s+/).map(w=>w[0]).join('').slice(0,2).toUpperCase();
  x.fillStyle=fg; x.font=`bold ${canvasSize * 0.33}px "DM Sans",sans-serif`;
  x.textAlign='center'; x.textBaseline='middle'; x.fillText(ini,canvasSize/2,canvasSize/2 + 1);
  return c.toDataURL();
}

// Scale card to fit viewport on mobile
function scaleCardForMobile() {
  const card = document.getElementById('card');
  const previewArea = document.querySelector('.preview-area');
  const zoomControls = document.getElementById('zoom-controls');

  if (window.innerWidth <= 768) {
    const availableWidth = previewArea.clientWidth - 32;
    const cardWidth = card.offsetWidth;
    const scale = Math.min(1, availableWidth / cardWidth);
    card.style.transform = `scale(${scale})`;
    card.style.transformOrigin = 'top center';

    // Collapse the "ghost" space from transform - card visually shrinks but DOM box stays full size
    // Add negative margin to compensate for the unused vertical space
    card.style.marginBottom = -(card.offsetHeight * (1 - scale)) + 'px';

    // Calculate preview area height: scaled card + padding (16px top + 16px bottom) + gap + zoom controls
    const zoomControlsHeight = (zoomControls && zoomControls.style.display !== 'none')
      ? zoomControls.offsetHeight + 12 // 12px gap
      : 0;
    previewArea.style.height = (card.offsetHeight * scale) + 32 + zoomControlsHeight + 'px';

  } else {
    card.style.transform = '';
    card.style.marginBottom = '';
    previewArea.style.height = '';
  }
}

// Live update
function liveUpdate(){
  const bg            = getPickerColor('bg');
  const nameColor     = getPickerColor('name');
  const handleColor   = getPickerColor('handle');
  const headlineColor = getPickerColor('headline');
  const bodyColor     = getPickerColor('body');
  const fontKey  = gv('font-select');
  const verified = gv('verified-select');
  const rounded  = document.getElementById('rounded-img-check').checked;
  const showImg  = document.getElementById('show-img-check').checked;
  const name     = gv('name-input');
  const handle   = gv('handle-input');
  const title    = gv('title-input');
  const body     = gv('body-input');

  // Update display values from sliders
  const insetFromSlider = parseInt(gv('inset-range'));
  const radiusFromSlider = parseInt(gv('radius-range'));
  sizes.inset = insetFromSlider;
  sizes.cornerRadius = radiusFromSlider;
  updateStepperUI('inset');
  updateStepperUI('cornerRadius');

  const inset = sizes.inset;
  const radius = sizes.cornerRadius;

  document.getElementById('inset-val').textContent = inset;
  document.getElementById('radius-val').textContent = radius;

  // Card base styles
  const card = document.getElementById('card');
  card.style.background   = bg;
  card.style.fontFamily   = FONT_CSS[fontKey];
  card.style.borderRadius = radius + 'px';

  // Avatar size
  const avatarEl = document.getElementById('avatar-display');
  avatarEl.style.width = sizes.avatarSize + 'px';
  avatarEl.style.height = sizes.avatarSize + 'px';

  // Text content with sizes
  const nameEl = document.getElementById('display-name');
  nameEl.textContent = name;
  nameEl.style.fontSize = sizes.nameSize + 'px';
  nameEl.style.color = nameColor;

  const handleEl = document.getElementById('display-handle');
  handleEl.textContent = handle;
  handleEl.style.fontSize = sizes.handleSize + 'px';
  handleEl.style.color = handleColor;

  const titleEl = document.getElementById('display-title');
  titleEl.innerHTML = parseMarkdown(title);
  titleEl.style.fontWeight = '800';
  titleEl.style.fontSize = sizes.titleSize + 'px';
  titleEl.style.marginBottom = '10px';
  titleEl.style.lineHeight = '1.3';
  titleEl.style.color = headlineColor;

  const bodyEl = document.getElementById('display-body');
  bodyEl.innerHTML = '';
  body.split('\n').filter(l=>l.trim()).forEach(line=>{
    const p=document.createElement('p');
    p.innerHTML = parseMarkdown(line);
    p.style.fontSize = sizes.bodySize + 'px';
    p.style.color = bodyColor;
    bodyEl.appendChild(p);
  });

  // Verified badge
  const icon = document.getElementById('verified-icon');
  if(verified==='none'){ icon.style.display='none'; }
  else {
    icon.style.display='inline-block';
    icon.querySelector('circle').setAttribute('fill', verified==='gold'?'#F4A400':'#2d49b9');
  }

  // Avatar
  if(!avatarDataURL)
    avatarEl.src = makeInitialsAvatar(name, nameColor, bg, sizes.avatarSize);

  // Image slots
  const slotTop    = document.getElementById('img-slot-top');
  const slotBottom = document.getElementById('img-slot-bottom');

  // Show/hide zoom controls based on image and fit mode
  const zoomControls = document.getElementById('zoom-controls');
  zoomControls.style.display = (cardImgDataURL && showImg && imgFit === 'cover') ? 'flex' : 'none';

  if (!showImg) {
    slotTop.style.display = 'none';
    slotBottom.style.display = 'none';
  } else {
    slotTop.style.display    = imgPosition==='top'    ? 'block' : 'none';
    slotBottom.style.display = imgPosition==='bottom' ? 'block' : 'none';
  }

  // Compute image height from card width & ratio
  const cardW = card.offsetWidth || sizes.width;
  const ratio  = ratioNum(imgRatio);

  const slotW   = cardW - inset * 2;
  const slotH   = Math.round(slotW / ratio);

  const imgCornerR = rounded ? Math.max(4, Math.min(16, inset + 2)) : 0;

  function styleSlot(slot, imgEl, phEl, w, h, marginStr){
    slot.style.width        = w + 'px';
    slot.style.height       = h + 'px';
    slot.style.margin       = marginStr;
    slot.style.borderRadius = imgCornerR + 'px';
    slot.style.overflow     = 'hidden';
    if(imgEl){
      imgEl.style.height = h + 'px';
      if (imgFit === 'cover') {
        // Constrain offsets to prevent dragging out of view
        const maxOffsetX = (imgZoom - 1) * w / (2 * imgZoom);
        const maxOffsetY = (imgZoom - 1) * h / (2 * imgZoom);
        const constrainedX = Math.max(-maxOffsetX, Math.min(maxOffsetX, imgOffsetX));
        const constrainedY = Math.max(-maxOffsetY, Math.min(maxOffsetY, imgOffsetY));

        imgEl.style.objectFit = 'cover';
        imgEl.style.transform = `scale(${imgZoom}) translate(${constrainedX}px, ${constrainedY}px)`;
        imgEl.style.transformOrigin = 'center center';
      } else {
        imgEl.style.objectFit = 'contain';
        imgEl.style.transform = 'none';
      }
      imgEl.classList.toggle('draggable', imgFit === 'cover' && cardImgDataURL);
      imgEl.classList.toggle('contain-mode', imgFit === 'contain');
    }
    if(phEl)  phEl.style.height  = h + 'px';
    if(cardImgDataURL){
      if(imgEl){ imgEl.src=cardImgDataURL; imgEl.style.display='block'; }
      if(phEl)  phEl.style.display='none';
    } else {
      if(imgEl) imgEl.style.display='none';
      if(phEl)  phEl.style.display='flex';
    }
  }

  if(imgPosition==='top'){
    styleSlot(slotTop,
      document.getElementById('img-top'),
      document.getElementById('ph-top'),
      slotW, slotH,
      `${inset}px ${inset}px 0`
    );
  }
  if(imgPosition==='bottom'){
    styleSlot(slotBottom,
      document.getElementById('img-bottom'),
      document.getElementById('ph-bottom'),
      slotW, slotH,
      `0 ${inset}px ${inset}px`
    );
  }

  // Fixed height
  card.style.height   = sizes.height > 0 ? sizes.height + 'px' : 'auto';
  card.style.overflow = 'hidden';

  // Scale for mobile after DOM updates
  if (typeof scaleCardForMobile === 'function') {
    requestAnimationFrame(scaleCardForMobile);
  }

  // Persist state to localStorage
  saveState();
}

// Size / presets
function onSizeChange(){
  sizes.width = parseInt(gv('w-range'));
  sizes.height = parseInt(gv('h-range'));
  updateStepperUI('width');
  updateStepperUI('height');
  document.getElementById('card').style.width = sizes.width + 'px';
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  liveUpdate();
}

document.querySelectorAll('.preset-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const p = PLATFORM_PRESETS[btn.dataset.preset];
    sizes.width = p.w;
    sizes.height = p.h;
    document.getElementById('w-range').value = p.w;
    document.getElementById('h-range').value = p.h;
    updateStepperUI('width');
    updateStepperUI('height');
    document.getElementById('card').style.width = p.w + 'px';
    liveUpdate();
  });
});

document.querySelectorAll('.img-opt').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.img-opt').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    imgPosition = btn.dataset.pos;
    liveUpdate();
  });
});

document.querySelectorAll('.aspect-opt').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.aspect-opt').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    imgRatio = btn.dataset.ratio;
    liveUpdate();
  });
});

document.querySelectorAll('.fit-opt').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.fit-opt').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    imgFit = btn.dataset.fit;
    liveUpdate();
  });
});

// Zoom controls
function updateZoomUI() {
  document.getElementById('zoom-value').textContent = Math.round(imgZoom * 100) + '%';
  document.getElementById('zoom-out').disabled = imgZoom <= 1;
  document.getElementById('zoom-in').disabled = imgZoom >= 4;
}

document.getElementById('zoom-in').addEventListener('click', () => {
  if (imgZoom < 4) {
    imgZoom = Math.min(4, imgZoom + 0.25);
    updateZoomUI();
    liveUpdate();
  }
});

document.getElementById('zoom-out').addEventListener('click', () => {
  if (imgZoom > 1) {
    imgZoom = Math.max(1, imgZoom - 0.25);
    updateZoomUI();
    liveUpdate();
  }
});

document.getElementById('zoom-reset').addEventListener('click', () => {
  imgZoom = 1;
  imgOffsetX = 0;
  imgOffsetY = 0;
  updateZoomUI();
  liveUpdate();
});

updateZoomUI();

// Image drag for cover mode positioning
let isDraggingImg = false;
let dragStartX = 0;
let dragStartY = 0;
let dragStartOffsetX = 0;
let dragStartOffsetY = 0;

function handleDragStart(clientX, clientY) {
  if (imgFit !== 'cover' || !cardImgDataURL) return false;
  isDraggingImg = true;
  dragStartX = clientX;
  dragStartY = clientY;
  dragStartOffsetX = imgOffsetX;
  dragStartOffsetY = imgOffsetY;

  const activeImg = imgPosition === 'top'
    ? document.getElementById('img-top')
    : document.getElementById('img-bottom');
  if (activeImg) activeImg.classList.add('dragging');

  return true;
}

function handleDragMove(clientX, clientY) {
  if (!isDraggingImg) return;

  const activeSlot = imgPosition === 'top'
    ? document.getElementById('img-slot-top')
    : document.getElementById('img-slot-bottom');

  if (!activeSlot) return;

  // Calculate pixel delta and adjust for zoom level
  const deltaX = (clientX - dragStartX) / imgZoom;
  const deltaY = (clientY - dragStartY) / imgZoom;

  // Calculate max offset to prevent dragging image out of view
  // At zoom = 1, maxOffset = 0 (can't pan)
  // At zoom > 1, maxOffset = half the extra space created by zoom
  const maxOffsetX = (imgZoom - 1) * activeSlot.offsetWidth / (2 * imgZoom);
  const maxOffsetY = (imgZoom - 1) * activeSlot.offsetHeight / (2 * imgZoom);

  imgOffsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, dragStartOffsetX + deltaX));
  imgOffsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, dragStartOffsetY + deltaY));

  // Apply transform directly to the visible image
  const activeImg = imgPosition === 'top'
    ? document.getElementById('img-top')
    : document.getElementById('img-bottom');

  if (activeImg) {
    activeImg.style.transform = `scale(${imgZoom}) translate(${imgOffsetX}px, ${imgOffsetY}px)`;
  }
}

function handleDragEnd() {
  if (isDraggingImg) {
    isDraggingImg = false;
    document.querySelectorAll('.img-wrap img').forEach(img => img.classList.remove('dragging'));
    saveState();
  }
}

function setupImageDrag(imgEl) {
  if (!imgEl) return;

  // Mouse events
  imgEl.addEventListener('mousedown', (e) => {
    e.preventDefault();
    handleDragStart(e.clientX, e.clientY);
  });

  // Touch events
  imgEl.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      e.preventDefault();
      const touch = e.touches[0];
      handleDragStart(touch.clientX, touch.clientY);
    }
  }, { passive: false });
}

// Setup drag for both image slots
setupImageDrag(document.getElementById('img-top'));
setupImageDrag(document.getElementById('img-bottom'));

// Mouse move/up on document
document.addEventListener('mousemove', (e) => {
  handleDragMove(e.clientX, e.clientY);
});

document.addEventListener('mouseup', handleDragEnd);

// Touch move/end on document
document.addEventListener('touchmove', (e) => {
  if (isDraggingImg && e.touches.length === 1) {
    e.preventDefault();
    const touch = e.touches[0];
    handleDragMove(touch.clientX, touch.clientY);
  }
}, { passive: false });

document.addEventListener('touchend', handleDragEnd);
document.addEventListener('touchcancel', handleDragEnd);

// File handlers
function handleAvatar(e){
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{
    avatarDataURL=ev.target.result;
    document.getElementById('avatar-display').src=avatarDataURL;
    const b=document.getElementById('avatar-btn');
    b.textContent='✓ '+file.name; b.classList.add('has-file');
  };
  r.readAsDataURL(file);
}

function handleCardImage(e){
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{
    cardImgDataURL=ev.target.result;
    const b=document.getElementById('card-img-btn');
    b.textContent='✓ '+file.name; b.classList.add('has-file');
    liveUpdate();
  };
  r.readAsDataURL(file);
}

// Export
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2400);
}

async function exportCard(fmt){
  showToast('Rendering…');
  try{
    await document.fonts.ready;
    const card = document.getElementById('card');
    const options = {
      pixelRatio: 4,
      filter: (node) => {
        if(node.tagName === 'IMG' && !node.getAttribute('src')) return false;
        return true;
      }
    };

    let dataUrl;
    if(fmt === 'jpeg'){
      dataUrl = await htmlToImage.toJpeg(card, { ...options, quality: 0.92 });
    } else {
      dataUrl = await htmlToImage.toPng(card, options);
    }

    const a = document.createElement('a');
    a.download = 'card.' + fmt;
    a.href = dataUrl;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast('✓ Downloaded!');
  }catch(e){console.error(e);showToast('⚠ Export failed');}
}

async function copyCard(){
  showToast('Rendering…');
  try{
    await document.fonts.ready;
    const card = document.getElementById('card');
    const blob = await htmlToImage.toBlob(card, {
      pixelRatio: 4,
      filter: (node) => {
        if(node.tagName === 'IMG' && !node.getAttribute('src')) return false;
        return true;
      }
    });
    await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
    showToast('✓ Copied!');
  }catch(e){console.error(e);showToast('⚠ Clipboard blocked — try downloading');}
}

// State persistence
const STORAGE_KEY = 'mockly-state';

function saveState() {
  const state = {
    inputs: {
      name: gv('name-input'),
      handle: gv('handle-input'),
      title: gv('title-input'),
      body: gv('body-input'),
      font: gv('font-select'),
      verified: gv('verified-select'),
      rounded: document.getElementById('rounded-img-check').checked,
      showImg: document.getElementById('show-img-check').checked
    },
    colors: colorPickerState,
    sizes: { ...sizes },
    images: {
      avatar: avatarDataURL,
      cardImg: cardImgDataURL,
      position: imgPosition,
      ratio: imgRatio,
      fit: imgFit,
      offsetX: imgOffsetX,
      offsetY: imgOffsetY,
      zoom: imgZoom
    },
    sliders: {
      inset: gv('inset-range'),
      radius: gv('radius-range')
    }
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function restoreState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return false;

  try {
    const state = JSON.parse(saved);

    // Restore text inputs
    if (state.inputs) {
      sv('name-input', state.inputs.name || '');
      sv('handle-input', state.inputs.handle || '');
      sv('title-input', state.inputs.title || '');
      sv('body-input', state.inputs.body || '');
      sv('font-select', state.inputs.font || 'syne');
      sv('verified-select', state.inputs.verified || 'none');
      document.getElementById('rounded-img-check').checked = state.inputs.rounded || false;
      document.getElementById('show-img-check').checked = state.inputs.showImg !== false;
    }

    // Restore colors
    if (state.colors) {
      ['bg', 'name', 'handle', 'headline', 'body'].forEach(prefix => {
        if (state.colors[prefix]) {
          Object.assign(colorPickerState[prefix], state.colors[prefix]);
          updateColorPickerUI(prefix);
        }
      });
    }

    // Restore sizes
    if (state.sizes) {
      Object.assign(sizes, state.sizes);
    }

    // Restore sliders
    if (state.sliders) {
      sv('inset-range', state.sliders.inset || sizes.inset);
      sv('radius-range', state.sliders.radius || sizes.cornerRadius);
    }

    // Restore images
    if (state.images) {
      avatarDataURL = state.images.avatar;
      cardImgDataURL = state.images.cardImg;
      imgPosition = state.images.position || 'bottom';
      imgRatio = state.images.ratio || '16/9';
      imgFit = state.images.fit || 'cover';
      imgOffsetX = state.images.offsetX ?? 0;
      imgOffsetY = state.images.offsetY ?? 0;
      imgZoom = state.images.zoom ?? 1;

      if (avatarDataURL) {
        document.getElementById('avatar-display').src = avatarDataURL;
      }
      if (cardImgDataURL) {
        document.getElementById('card-image').src = cardImgDataURL;
        document.getElementById('card-image').style.display = 'block';
      }

      // Restore fit mode button state
      document.querySelectorAll('.fit-opt').forEach(b => {
        b.classList.toggle('active', b.dataset.fit === imgFit);
      });

      // Restore zoom UI
      if (typeof updateZoomUI === 'function') updateZoomUI();
    }

    return true;
  } catch (e) {
    console.warn('Could not restore state:', e);
    return false;
  }
}

function resetAll() {
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

// Init
(async function(){
  const link = document.querySelector('link[href*="fonts.googleapis.com"]');
  if(!link) return;
  try{
    const res = await fetch(link.href);
    const css = await res.text();
    document.getElementById('google-fonts-inline').textContent = css;
    link.remove();
  }catch(e){ console.warn('Could not inline Google Fonts CSS:', e); }
})();

document.getElementById('card').style.width = sizes.width + 'px';
initColorPickers();
restoreState();
liveUpdate();

// Initialize mobile scaling
window.addEventListener('resize', scaleCardForMobile);
scaleCardForMobile();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mockly</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<style id="google-fonts-inline"></style>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0f0f13; --surface: #1a1a22; --border: #2a2a38;
  --accent: #6c8ef7; --accent2: #f76c8e; --text: #e8e8f0; --muted: #8888aa;
}
body {
  background: var(--bg); color: var(--text);
  font-family: 'DM Sans', sans-serif;
  display: grid;
  grid-template-columns: 400px 1fr;
  grid-template-rows: 52px 1fr;
  height: 100vh; overflow: hidden;
}
header {
  grid-column: 1/-1; background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 22px; gap: 10px;
}
header h1 { font-family:'Syne',sans-serif; font-weight:800; font-size:16px; }
header h1 span { color: var(--accent); }
.badge {
  background: linear-gradient(135deg,var(--accent),var(--accent2));
  color:#fff; font-size:9px; font-weight:700;
  padding:2px 7px; border-radius:99px; letter-spacing:1px; text-transform:uppercase;
}
.controls {
  background:var(--surface); border-right:1px solid var(--border);
  overflow-y:auto; padding:16px 16px 28px;
  display:flex; flex-direction:column; gap:3px;
}
.sec { font-family:'Syne',sans-serif; font-size:9px; font-weight:700;
  letter-spacing:1.5px; text-transform:uppercase; color:var(--muted);
  margin:14px 0 5px; }
.sec:first-child { margin-top:0; }

/* Control row with label + steppers */
.ctrl-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}
.ctrl-label {
  font-size: 11px;
  color: var(--muted);
}
.ctrl-steppers {
  display: flex;
  align-items: center;
  gap: 3px;
}
.stepper-btn {
  width: 22px; height: 22px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--muted);
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .12s;
}
.stepper-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.stepper-btn.reset {
  font-size: 10px;
}
.stepper-val {
  min-width: 36px;
  text-align: center;
  font-size: 11px;
  color: var(--text);
}

label { font-size:11px; color:var(--muted); display:block; margin-bottom:3px; }
input[type=text], textarea, select {
  width:100%; background:var(--bg); border:1px solid var(--border);
  border-radius:7px; color:var(--text); font-family:'DM Sans',sans-serif;
  font-size:12.5px; padding:6px 9px; outline:none;
  transition:border-color .15s; margin-bottom:8px;
}
input[type=text]:focus, textarea:focus, select:focus { border-color:var(--accent); }
textarea { resize:vertical; min-height:68px; line-height:1.5; }
select option { background:#1a1a22; }
.presets { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:8px; }
.preset-btn {
  background:var(--bg); border:1px solid var(--border);
  border-radius:6px; color:var(--muted); font-size:10.5px;
  padding:4px 9px; cursor:pointer; transition:all .12s; font-family:'DM Sans',sans-serif;
}
.preset-btn:hover, .preset-btn.active { border-color:var(--accent); color:var(--accent); }
.slider-group { margin-bottom:8px; }
.slider-group label { display:flex; justify-content:space-between; align-items:center; }
.slider-group label span { color:var(--text); }
input[type=range] { width:100%; accent-color:var(--accent); margin-top:4px; display:block; }
.color-row { display:flex; align-items:center; gap:9px; margin-bottom:8px; }
input[type=color] {
  width:32px; height:32px; border:1px solid var(--border);
  border-radius:6px; background:none; cursor:pointer; padding:2px; flex-shrink:0;
}
input[type=color]::-webkit-color-swatch-wrapper{padding:0;border-radius:4px}
input[type=color]::-webkit-color-swatch{border:none;border-radius:3px}
.upload-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.upload-btn {
  flex: 1;
  background:var(--bg); border:1px dashed var(--border);
  border-radius:7px; color:var(--muted); font-family:'DM Sans',sans-serif;
  font-size:11.5px; padding:8px; cursor:pointer; text-align:center;
  transition:all .15s;
}
.upload-btn:hover { border-color:var(--accent); color:var(--accent); }
.upload-btn.has-file { border-color:#4ade80; color:#4ade80; border-style:solid; }
.img-options { display:flex; gap:5px; margin-bottom:8px; }
.img-opt {
  flex:1; background:var(--bg); border:1px solid var(--border);
  border-radius:7px; color:var(--muted); font-size:10px;
  padding:6px 4px; cursor:pointer; text-align:center;
  transition:all .12s; font-family:'DM Sans',sans-serif; line-height:1.3;
}
.img-opt:hover, .img-opt.active { border-color:var(--accent); color:var(--accent); }
.aspect-options { display:flex; gap:5px; margin-bottom:8px; }
.aspect-opt {
  flex:1; background:var(--bg); border:1px solid var(--border);
  border-radius:7px; color:var(--muted); font-size:10px;
  padding:5px 4px; cursor:pointer; text-align:center;
  transition:all .12s; font-family:'DM Sans',sans-serif;
}
.aspect-opt:hover, .aspect-opt.active { border-color:var(--accent); color:var(--accent); }
.export-group { display:flex; flex-direction:column; gap:5px; margin-top:10px; }
.export-btn {
  width:100%; border:none; border-radius:7px;
  font-family:'Syne',sans-serif; font-weight:700; font-size:12px;
  letter-spacing:.3px; padding:9px; cursor:pointer; transition:opacity .15s, transform .1s;
}
.export-btn:hover { opacity:.88; transform:translateY(-1px); }
.export-btn:active { transform:translateY(0); }
.export-btn.primary { background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; }
.export-btn.sec-btn { background:var(--bg); border:1px solid var(--border); color:var(--text); }
.export-btn.sec-btn:hover { border-color:var(--accent); color:var(--accent); }
.toast {
  position:fixed; bottom:22px; left:50%;
  transform:translateX(-50%) translateY(14px);
  background:#222230; border:1px solid var(--border); color:var(--text);
  font-size:12.5px; padding:8px 18px; border-radius:99px;
  opacity:0; transition:all .2s; pointer-events:none; z-index:999;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* PREVIEW */
.preview-area {
  display:flex; align-items:center; justify-content:center;
  padding:32px; overflow:auto;
  background:repeating-conic-gradient(#1a1a22 0% 25%,#161620 0% 50%) 0 0/20px 20px;
}

/* Markdown styles in card */
.card-text strong { font-weight: 700; }
.card-text em { font-style: italic; }
.card-text code {
  background: rgba(0,0,0,0.2);
  padding: 1px 5px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}
.card-text a {
  color: inherit;
  text-decoration: underline;
  text-decoration-color: rgba(255,255,255,0.5);
}

/* THE CARD */
#card {
  border-radius:16px; overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
  position:relative; flex-shrink:0;
  display:flex; flex-direction:column;
}
.card-inner { padding:22px 22px 18px; flex-shrink:0; }
.card-header { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
#avatar-display {
  width:40px; height:40px; border-radius:50%;
  object-fit:cover; flex-shrink:0; background:#555;
}
.card-identity { display:flex; flex-direction:column; }
.card-name-row { display:flex; align-items:center; gap:5px; }
#display-name { font-weight:700; font-size:14.5px; line-height:1.2; }
.vbadge { width:16px; height:16px; flex-shrink:0; }
#display-handle { font-size:13px; margin-top:1px; opacity:.6; }
.card-body { flex-shrink:0; }
#display-title { font-weight:800; font-size:18px; margin-bottom:10px; line-height:1.3; }
.card-text p { font-size:14.5px; line-height:1.55; margin-bottom:8px; opacity:.88; }
.card-text p:last-child { margin-bottom:0; }

/* image wrappers */
.img-wrap {
  flex-shrink:0; overflow:hidden; line-height:0;
  transition: margin .15s, border-radius .15s;
}
.img-wrap img { width:100%; height:100%; object-fit:cover; display:block; }
.img-placeholder {
  width:100%; height:100%; display:flex; align-items:center; justify-content:center;
  color:rgba(255,255,255,.2); font-size:12px; background:rgba(0,0,0,.12);
}
</style>
</head>
<body>

<header>
  <h1>Mock<span>ly</span></h1>
  <div class="badge">Studio</div>
</header>

<!-- CONTROLS -->
<div class="controls">

  <div class="sec">Platform Presets</div>
  <div class="presets">
    <button class="preset-btn active" data-preset="twitter">Twitter/X</button>
    <button class="preset-btn" data-preset="instagram">Instagram</button>
    <button class="preset-btn" data-preset="linkedin">LinkedIn</button>
    <button class="preset-btn" data-preset="story">Story</button>
    <button class="preset-btn" data-preset="og">OG Image</button>
  </div>

  <div class="sec">Canvas Size</div>
  <div class="ctrl-row">
    <span class="ctrl-label">Width</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('width', -10)">−</button>
      <span class="stepper-val" id="w-val">516px</span>
      <button class="stepper-btn" onclick="adjustValue('width', 10)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('width')">↺</button>
    </div>
  </div>
  <input type="range" id="w-range" min="300" max="900" value="516" oninput="onSizeChange()">
  <div class="ctrl-row">
    <span class="ctrl-label">Height</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('height', -10)">−</button>
      <span class="stepper-val" id="h-val">auto</span>
      <button class="stepper-btn" onclick="adjustValue('height', 10)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('height')">↺</button>
    </div>
  </div>
  <input type="range" id="h-range" min="0" max="900" value="0" oninput="onSizeChange()">
  <div style="font-size:10px;opacity:.5;margin-bottom:8px">0 = auto-height</div>

  <div class="sec">Profile</div>
  <div class="upload-row">
    <button class="upload-btn" id="avatar-btn" onclick="document.getElementById('avatar-upload').click()">↑ Upload avatar</button>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('avatarSize', -2)">−</button>
      <span class="stepper-val" id="avatar-size-val">40</span>
      <button class="stepper-btn" onclick="adjustValue('avatarSize', 2)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('avatarSize')">↺</button>
    </div>
  </div>
  <input type="file" id="avatar-upload" accept="image/*" style="display:none" onchange="handleAvatar(event)">

  <div class="ctrl-row">
    <span class="ctrl-label">Display Name</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('nameSize', -0.5)">−</button>
      <span class="stepper-val" id="name-size-val">14.5</span>
      <button class="stepper-btn" onclick="adjustValue('nameSize', 0.5)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('nameSize')">↺</button>
    </div>
  </div>
  <input type="text" id="name-input" value="Patent Press" oninput="liveUpdate()">

  <div class="ctrl-row">
    <span class="ctrl-label">Handle</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('handleSize', -0.5)">−</button>
      <span class="stepper-val" id="handle-size-val">13</span>
      <button class="stepper-btn" onclick="adjustValue('handleSize', 0.5)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('handleSize')">↺</button>
    </div>
  </div>
  <input type="text" id="handle-input" value="@patent.press" oninput="liveUpdate()">

  <label>Verified Badge</label>
  <select id="verified-select" onchange="liveUpdate()">
    <option value="blue">Blue ✓</option>
    <option value="gold">Gold ✓</option>
    <option value="none">None</option>
  </select>

  <div class="sec">Content</div>
  <div class="ctrl-row">
    <span class="ctrl-label">Headline</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('titleSize', -1)">−</button>
      <span class="stepper-val" id="title-size-val">18</span>
      <button class="stepper-btn" onclick="adjustValue('titleSize', 1)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('titleSize')">↺</button>
    </div>
  </div>
  <input type="text" id="title-input" value="AI takes the wheel" oninput="liveUpdate()">

  <div class="ctrl-row">
    <span class="ctrl-label">Body (supports **bold**, *italic*, `code`, [link](url))</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('bodySize', -0.5)">−</button>
      <span class="stepper-val" id="body-size-val">14.5</span>
      <button class="stepper-btn" onclick="adjustValue('bodySize', 0.5)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('bodySize')">↺</button>
    </div>
  </div>
  <textarea id="body-input" oninput="liveUpdate()">Strong Force's new patent envisions cars that know your feelings.
Sensors track your heartbeat, sweat, voice stress and cabin humidity. AI fuses this with driving data to track your emotive state.
It can blast air, adjust lights, or even take control of the wheel.</textarea>

  <div class="sec">Card Image</div>
  <button class="upload-btn" id="card-img-btn" onclick="document.getElementById('card-img-upload').click()">↑ Upload image</button>
  <input type="file" id="card-img-upload" accept="image/*" style="display:none" onchange="handleCardImage(event)">

  <label>Image Position</label>
  <div class="img-options">
    <button class="img-opt active" data-pos="bottom">↓ Bottom</button>
    <button class="img-opt" data-pos="top">↑ Top</button>
  </div>

  <label>Aspect Ratio</label>
  <div class="aspect-options">
    <button class="aspect-opt active" data-ratio="16/9">16:9</button>
    <button class="aspect-opt" data-ratio="4/3">4:3</button>
    <button class="aspect-opt" data-ratio="1/1">1:1</button>
    <button class="aspect-opt" data-ratio="9/16">9:16</button>
  </div>

  <label style="margin-top:2px">
    <input type="checkbox" id="rounded-img-check" onchange="liveUpdate()" checked
      style="accent-color:var(--accent);margin-right:5px">
    Rounded image corners
  </label>

  <div class="ctrl-row" style="margin-top:8px">
    <span class="ctrl-label">Image Inset</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('inset', -1)">−</button>
      <span class="stepper-val" id="inset-val">10</span>
      <button class="stepper-btn" onclick="adjustValue('inset', 1)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('inset')">↺</button>
    </div>
  </div>
  <input type="range" id="inset-range" min="0" max="24" value="10" oninput="liveUpdate()">

  <div class="sec">Style</div>
  <div class="color-row">
    <input type="color" id="bg-color" value="#2d49b8" oninput="liveUpdate()">
    <label style="margin:0;flex:1">Background</label>
    <button class="stepper-btn reset" onclick="resetValue('bgColor')">↺</button>
  </div>
  <div class="color-row">
    <input type="color" id="text-color" value="#ffffff" oninput="liveUpdate()">
    <label style="margin:0;flex:1">Text color</label>
    <button class="stepper-btn reset" onclick="resetValue('textColor')">↺</button>
  </div>
  <label>Font</label>
  <select id="font-select" onchange="liveUpdate()">
    <option value="system">System UI</option>
    <option value="georgia">Georgia (Serif)</option>
    <option value="courier">Courier New (Mono)</option>
    <option value="syne">Syne (Geometric)</option>
    <option value="dmsans">DM Sans (Clean)</option>
  </select>

  <div class="ctrl-row">
    <span class="ctrl-label">Corner Radius</span>
    <div class="ctrl-steppers">
      <button class="stepper-btn" onclick="adjustValue('cornerRadius', -1)">−</button>
      <span class="stepper-val" id="radius-val">16</span>
      <button class="stepper-btn" onclick="adjustValue('cornerRadius', 1)">+</button>
      <button class="stepper-btn reset" onclick="resetValue('cornerRadius')">↺</button>
    </div>
  </div>
  <input type="range" id="radius-range" min="0" max="40" value="16" oninput="liveUpdate()">

  <div class="export-group">
    <button class="export-btn primary" onclick="exportCard('png')">⬇ Download PNG</button>
    <button class="export-btn sec-btn" onclick="exportCard('jpeg')">⬇ Download JPEG</button>
    <button class="export-btn sec-btn" onclick="copyCard()">⎘ Copy to Clipboard</button>
  </div>
</div>

<!-- PREVIEW -->
<div class="preview-area">
  <div id="card">
    <!-- top image slot -->
    <div id="img-slot-top" class="img-wrap" style="display:none">
      <img id="img-top" alt="">
      <div class="img-placeholder" id="ph-top"></div>
    </div>

    <div class="card-inner">
      <div class="card-header">
        <img id="avatar-display" src="" alt="avatar">
        <div class="card-identity">
          <div class="card-name-row">
            <span id="display-name">Patent Press</span>
            <svg id="verified-icon" class="vbadge" viewBox="0 0 22 22" fill="none">
              <circle cx="11" cy="11" r="11" fill="#1D9BF0"/>
              <path d="M7 11.5L10 14.5L15 8.5" stroke="white" stroke-width="2.2"
                stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <span id="display-handle">@patent.press</span>
        </div>
      </div>

      <div class="card-body">
        <div id="display-title">AI takes the wheel</div>
        <div id="display-body" class="card-text"></div>
      </div>

    </div>

    <!-- bottom image slot -->
    <div id="img-slot-bottom" class="img-wrap">
      <img id="img-bottom" alt="" style="display:none">
      <div class="img-placeholder" id="ph-bottom">No image uploaded</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
<script>
// DEFAULTS
const DEFAULTS = {
  width: 516,
  height: 0,
  nameSize: 14.5,
  handleSize: 13,
  titleSize: 18,
  bodySize: 14.5,
  avatarSize: 40,
  cornerRadius: 16,
  inset: 10,
  bgColor: '#2d49b8',
  textColor: '#ffffff'
};

// Current state (sizes)
const sizes = {
  nameSize: DEFAULTS.nameSize,
  handleSize: DEFAULTS.handleSize,
  titleSize: DEFAULTS.titleSize,
  bodySize: DEFAULTS.bodySize,
  avatarSize: DEFAULTS.avatarSize,
  cornerRadius: DEFAULTS.cornerRadius,
  inset: DEFAULTS.inset,
  width: DEFAULTS.width,
  height: DEFAULTS.height
};

let avatarDataURL  = null;
let cardImgDataURL = null;
let imgPosition    = 'bottom';
let imgRatio       = '16/9';

const PLATFORM_PRESETS = {
  twitter:   { w: 516, h: 0 },
  instagram: { w: 600, h: 600 },
  linkedin:  { w: 700, h: 0 },
  story:     { w: 400, h: 711 },
  og:        { w: 800, h: 418 },
};

const FONT_CSS = {
  system:  "-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif",
  georgia: "Georgia,serif",
  courier: "'Courier New',monospace",
  syne:    "Syne,sans-serif",
  dmsans:  "'DM Sans',sans-serif",
};

// Sizing limits
const LIMITS = {
  nameSize: { min: 10, max: 24, step: 0.5 },
  handleSize: { min: 10, max: 20, step: 0.5 },
  titleSize: { min: 12, max: 32, step: 1 },
  bodySize: { min: 10, max: 24, step: 0.5 },
  avatarSize: { min: 24, max: 64, step: 2 },
  cornerRadius: { min: 0, max: 40, step: 1 },
  inset: { min: 0, max: 24, step: 1 },
  width: { min: 300, max: 900, step: 10 },
  height: { min: 0, max: 900, step: 10 }
};

function gv(id){ return document.getElementById(id).value; }
function ratioNum(r){ const [a,b]=r.split('/').map(Number); return a/b; }

// Stepper functions
function adjustValue(key, delta) {
  const limit = LIMITS[key];
  sizes[key] = Math.max(limit.min, Math.min(limit.max, sizes[key] + delta));
  updateStepperUI(key);
  syncSliderToState(key);
  liveUpdate();
}

function resetValue(key) {
  if (key === 'bgColor') {
    document.getElementById('bg-color').value = DEFAULTS.bgColor;
    liveUpdate();
    return;
  }
  if (key === 'textColor') {
    document.getElementById('text-color').value = DEFAULTS.textColor;
    liveUpdate();
    return;
  }
  sizes[key] = DEFAULTS[key];
  updateStepperUI(key);
  syncSliderToState(key);
  liveUpdate();
}

function updateStepperUI(key) {
  const valEl = document.getElementById(keyToValId(key));
  if (valEl) {
    let display = sizes[key];
    if (key === 'width') {
      valEl.textContent = display + 'px';
    } else if (key === 'height') {
      valEl.textContent = display === 0 ? 'auto' : display + 'px';
    } else {
      valEl.textContent = display;
    }
  }
}

function keyToValId(key) {
  const map = {
    nameSize: 'name-size-val',
    handleSize: 'handle-size-val',
    titleSize: 'title-size-val',
    bodySize: 'body-size-val',
    avatarSize: 'avatar-size-val',
    cornerRadius: 'radius-val',
    inset: 'inset-val',
    width: 'w-val',
    height: 'h-val'
  };
  return map[key];
}

function keyToRangeId(key) {
  const map = {
    cornerRadius: 'radius-range',
    inset: 'inset-range',
    width: 'w-range',
    height: 'h-range'
  };
  return map[key];
}

function syncSliderToState(key) {
  const rangeId = keyToRangeId(key);
  if (rangeId) {
    const range = document.getElementById(rangeId);
    if (range) range.value = sizes[key];
  }
}

// Markdown parser (basic)
function parseMarkdown(text) {
  return text
    // Escape HTML
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    // Links: [text](url)
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
    // Bold: **text** or __text__
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/__([^_]+)__/g, '<strong>$1</strong>')
    // Italic: *text* or _text_
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/_([^_]+)_/g, '<em>$1</em>')
    // Code: `text`
    .replace(/`([^`]+)`/g, '<code>$1</code>');
}

function makeInitialsAvatar(name, fg, bg, size){
  const c=document.createElement('canvas');
  const canvasSize = size * 2;
  c.width=c.height=canvasSize;
  const x=c.getContext('2d');
  x.fillStyle=bg; x.beginPath(); x.arc(canvasSize/2,canvasSize/2,canvasSize/2,0,Math.PI*2); x.fill();
  const ini=(name||'?').trim().split(/\s+/).map(w=>w[0]).join('').slice(0,2).toUpperCase();
  x.fillStyle=fg; x.font=`bold ${canvasSize * 0.33}px "DM Sans",sans-serif`;
  x.textAlign='center'; x.textBaseline='middle'; x.fillText(ini,canvasSize/2,canvasSize/2 + 1);
  return c.toDataURL();
}

// Live update
function liveUpdate(){
  const bg       = gv('bg-color');
  const textCol  = gv('text-color');
  const fontKey  = gv('font-select');
  const verified = gv('verified-select');
  const rounded  = document.getElementById('rounded-img-check').checked;
  const name     = gv('name-input');
  const handle   = gv('handle-input');
  const title    = gv('title-input');
  const body     = gv('body-input');

  // Update display values from sliders
  const insetFromSlider = parseInt(gv('inset-range'));
  const radiusFromSlider = parseInt(gv('radius-range'));
  sizes.inset = insetFromSlider;
  sizes.cornerRadius = radiusFromSlider;
  updateStepperUI('inset');
  updateStepperUI('cornerRadius');

  const inset = sizes.inset;
  const radius = sizes.cornerRadius;

  document.getElementById('inset-val').textContent = inset;
  document.getElementById('radius-val').textContent = radius;

  // Card base styles
  const card = document.getElementById('card');
  card.style.background   = bg;
  card.style.color        = textCol;
  card.style.fontFamily   = FONT_CSS[fontKey];
  card.style.borderRadius = radius + 'px';

  // Avatar size
  const avatarEl = document.getElementById('avatar-display');
  avatarEl.style.width = sizes.avatarSize + 'px';
  avatarEl.style.height = sizes.avatarSize + 'px';

  // Text content with sizes
  const nameEl = document.getElementById('display-name');
  nameEl.textContent = name;
  nameEl.style.fontSize = sizes.nameSize + 'px';

  const handleEl = document.getElementById('display-handle');
  handleEl.textContent = handle;
  handleEl.style.fontSize = sizes.handleSize + 'px';

  const titleEl = document.getElementById('display-title');
  titleEl.innerHTML = parseMarkdown(title);
  titleEl.style.fontWeight = '800';
  titleEl.style.fontSize = sizes.titleSize + 'px';
  titleEl.style.marginBottom = '10px';
  titleEl.style.lineHeight = '1.3';

  const bodyEl = document.getElementById('display-body');
  bodyEl.innerHTML = '';
  body.split('\n').filter(l=>l.trim()).forEach(line=>{
    const p=document.createElement('p');
    p.innerHTML = parseMarkdown(line);
    p.style.fontSize = sizes.bodySize + 'px';
    bodyEl.appendChild(p);
  });

  // Verified badge
  const icon = document.getElementById('verified-icon');
  if(verified==='none'){ icon.style.display='none'; }
  else {
    icon.style.display='inline-block';
    icon.querySelector('circle').setAttribute('fill', verified==='gold'?'#F4A400':'#1D9BF0');
  }

  // Avatar
  if(!avatarDataURL)
    avatarEl.src = makeInitialsAvatar(name, textCol, bg, sizes.avatarSize);

  // Image slots
  const slotTop    = document.getElementById('img-slot-top');
  const slotBottom = document.getElementById('img-slot-bottom');
  slotTop.style.display    = imgPosition==='top'    ? 'block' : 'none';
  slotBottom.style.display = imgPosition==='bottom' ? 'block' : 'none';

  // Compute image height from card width & ratio
  const cardW = card.offsetWidth || sizes.width;
  const ratio  = ratioNum(imgRatio);

  const slotW   = cardW - inset * 2;
  const slotH   = Math.round(slotW / ratio);

  const imgCornerR = rounded ? Math.max(4, Math.min(16, inset + 2)) : 0;

  function styleSlot(slot, imgEl, phEl, w, h, marginStr){
    slot.style.width        = w + 'px';
    slot.style.height       = h + 'px';
    slot.style.margin       = marginStr;
    slot.style.borderRadius = imgCornerR + 'px';
    slot.style.overflow     = 'hidden';
    if(imgEl) imgEl.style.height = h + 'px';
    if(phEl)  phEl.style.height  = h + 'px';
    if(cardImgDataURL){
      if(imgEl){ imgEl.src=cardImgDataURL; imgEl.style.display='block'; }
      if(phEl)  phEl.style.display='none';
    } else {
      if(imgEl) imgEl.style.display='none';
      if(phEl)  phEl.style.display='flex';
    }
  }

  if(imgPosition==='top'){
    styleSlot(slotTop,
      document.getElementById('img-top'),
      document.getElementById('ph-top'),
      slotW, slotH,
      `${inset}px ${inset}px 0`
    );
  }
  if(imgPosition==='bottom'){
    styleSlot(slotBottom,
      document.getElementById('img-bottom'),
      document.getElementById('ph-bottom'),
      slotW, slotH,
      `0 ${inset}px ${inset}px`
    );
  }

  // Fixed height
  card.style.height   = sizes.height > 0 ? sizes.height + 'px' : 'auto';
  card.style.overflow = 'hidden';
}

// Size / presets
function onSizeChange(){
  sizes.width = parseInt(gv('w-range'));
  sizes.height = parseInt(gv('h-range'));
  updateStepperUI('width');
  updateStepperUI('height');
  document.getElementById('card').style.width = sizes.width + 'px';
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  liveUpdate();
}

document.querySelectorAll('.preset-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const p = PLATFORM_PRESETS[btn.dataset.preset];
    sizes.width = p.w;
    sizes.height = p.h;
    document.getElementById('w-range').value = p.w;
    document.getElementById('h-range').value = p.h;
    updateStepperUI('width');
    updateStepperUI('height');
    document.getElementById('card').style.width = p.w + 'px';
    liveUpdate();
  });
});

document.querySelectorAll('.img-opt').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.img-opt').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    imgPosition = btn.dataset.pos;
    liveUpdate();
  });
});

document.querySelectorAll('.aspect-opt').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.aspect-opt').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    imgRatio = btn.dataset.ratio;
    liveUpdate();
  });
});

// File handlers
function handleAvatar(e){
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{
    avatarDataURL=ev.target.result;
    document.getElementById('avatar-display').src=avatarDataURL;
    const b=document.getElementById('avatar-btn');
    b.textContent='✓ '+file.name; b.classList.add('has-file');
  };
  r.readAsDataURL(file);
}

function handleCardImage(e){
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{
    cardImgDataURL=ev.target.result;
    const b=document.getElementById('card-img-btn');
    b.textContent='✓ '+file.name; b.classList.add('has-file');
    liveUpdate();
  };
  r.readAsDataURL(file);
}

// Export
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2400);
}

async function exportCard(fmt){
  showToast('Rendering…');
  try{
    await document.fonts.ready;
    const card = document.getElementById('card');
    const options = {
      pixelRatio: 4,
      filter: (node) => {
        if(node.tagName === 'IMG' && !node.getAttribute('src')) return false;
        return true;
      }
    };

    let dataUrl;
    if(fmt === 'jpeg'){
      dataUrl = await htmlToImage.toJpeg(card, { ...options, quality: 0.92 });
    } else {
      dataUrl = await htmlToImage.toPng(card, options);
    }

    const a = document.createElement('a');
    a.download = 'card.' + fmt;
    a.href = dataUrl;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast('✓ Downloaded!');
  }catch(e){console.error(e);showToast('⚠ Export failed');}
}

async function copyCard(){
  showToast('Rendering…');
  try{
    await document.fonts.ready;
    const card = document.getElementById('card');
    const blob = await htmlToImage.toBlob(card, {
      pixelRatio: 4,
      filter: (node) => {
        if(node.tagName === 'IMG' && !node.getAttribute('src')) return false;
        return true;
      }
    });
    await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
    showToast('✓ Copied!');
  }catch(e){console.error(e);showToast('⚠ Clipboard blocked — try downloading');}
}

// Init
(async function(){
  const link = document.querySelector('link[href*="fonts.googleapis.com"]');
  if(!link) return;
  try{
    const res = await fetch(link.href);
    const css = await res.text();
    document.getElementById('google-fonts-inline').textContent = css;
    link.remove();
  }catch(e){ console.warn('Could not inline Google Fonts CSS:', e); }
})();

document.getElementById('card').style.width = sizes.width + 'px';
liveUpdate();
</script>
</body>
</html>
